<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Decision Logger</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #f5f5f5; color: #1d1c1d; }
    header { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 28px; font-weight: 700; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { background: #fff; padding: 20px; border-radius: 8px; }
    .stat-card h3 { font-size: 14px; color: #616061; margin-bottom: 8px; text-transform: uppercase; }
    .stat-card .number { font-size: 32px; font-weight: 700; }
    .filters { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
    .filter-group { flex: 1; min-width: 200px; }
    .filter-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 5px; }
    .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; }
    .decisions-table { background: #fff; border-radius: 8px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #f8f8f8; }
    th { text-align: left; padding: 15px; font-weight: 600; font-size: 14px; border-bottom: 2px solid #e0e0e0; }
    td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    tbody tr:hover { background: #f8f8f8; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .badge-product { background: #e8f5e9; color: #2e7d32; }
    .badge-ux { background: #e3f2fd; color: #1565c0; }
    .badge-technical { background: #fff3e0; color: #e65100; }
    .tag { background: #f0f0f0; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin: 2px; }
    .jira-link { color: #0052cc; text-decoration: none; font-weight: 500; }
    .jira-link:hover { text-decoration: underline; }
    .jira-title { color: #616061; font-size: 12px; }
    .loading { text-align: center; padding: 40px; }
    .export-btn { background: #611f69; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 10px; }
    .export-btn:hover { background: #4a154b; }
    .delete-btn { background: #dc3545; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .delete-btn:hover { background: #c82333; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: #fff; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center; }
    .modal h2 { margin-bottom: 15px; font-size: 20px; }
    .modal p { margin-bottom: 20px; color: #616061; }
    .modal-buttons { display: flex; gap: 10px; justify-content: center; }
    .modal-btn { padding: 10px 20px; border-radius: 4px; font-size: 14px; cursor: pointer; border: none; }
    .modal-btn-cancel { background: #e0e0e0; color: #333; }
    .modal-btn-cancel:hover { background: #d0d0d0; }
    .modal-btn-delete { background: #dc3545; color: #fff; }
    .modal-btn-delete:hover { background: #c82333; }
    .view-btn { background: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px; }
    .view-btn:hover { background: #0056b3; }
    .decision-text { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .detail-modal { max-width: 700px; width: 90%; text-align: left; max-height: 90vh; overflow-y: auto; }
    .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
    .detail-header h2 { margin: 0; font-size: 24px; }
    .detail-section { margin-bottom: 20px; }
    .detail-section h3 { font-size: 14px; color: #616061; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
    .detail-section .content { background: #f8f8f8; padding: 15px; border-radius: 6px; font-size: 15px; line-height: 1.6; }
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
    .detail-item { background: #f8f8f8; padding: 12px; border-radius: 6px; }
    .detail-item label { font-size: 12px; color: #616061; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 5px; }
    .detail-item .value { font-size: 14px; color: #1d1c1d; }
    .confidence-badge { background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600; display: inline-block; }
    .close-btn { background: #e0e0e0; color: #333; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .close-btn:hover { background: #d0d0d0; }
    .date-presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .preset-btn { background: #f0f0f0; border: 1px solid #e0e0e0; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .preset-btn:hover { background: #e8e8e8; }
    .preset-btn.active { background: #611f69; color: #fff; border-color: #611f69; }
    .date-inputs { display: flex; gap: 10px; }
    .date-inputs input { flex: 1; }
    .clear-dates-btn { background: #dc3545; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; }
    .clear-dates-btn:hover { background: #c82333; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>üìù Decision Logger</h1>
    </div>
  </header>
  <div class="container">
    <div class="stats">
      <div class="stat-card"><h3>Total</h3><div class="number" id="total-count">-</div></div>
      <div class="stat-card"><h3>Product</h3><div class="number" id="product-count">-</div></div>
      <div class="stat-card"><h3>UX</h3><div class="number" id="ux-count">-</div></div>
      <div class="stat-card"><h3>Technical</h3><div class="number" id="technical-count">-</div></div>
      <div class="stat-card"><h3>This Week</h3><div class="number" id="week-count">-</div></div>
    </div>
    <div class="filters">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" id="search" placeholder="Search...">
      </div>
      <div class="filter-group">
        <label>Type</label>
        <select id="type-filter">
          <option value="">All</option>
          <option value="product">Product</option>
          <option value="ux">UX</option>
          <option value="technical">Technical</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Epic</label>
        <input type="text" id="epic-filter" placeholder="LOK-123">
      </div>
      <div class="filter-group" style="flex: 2; min-width: 400px;">
        <label>Date Range</label>
        <div class="date-presets">
          <button class="preset-btn" onclick="setDatePreset('today')">Today</button>
          <button class="preset-btn" onclick="setDatePreset('last7')">Last 7 days</button>
          <button class="preset-btn" onclick="setDatePreset('last30')">Last 30 days</button>
          <button class="preset-btn" onclick="setDatePreset('thisMonth')">This month</button>
          <button class="preset-btn" onclick="setDatePreset('lastMonth')">Last month</button>
          <button class="clear-dates-btn" onclick="clearDateFilter()">Clear</button>
        </div>
        <div class="date-inputs">
          <input type="date" id="date-from" placeholder="From">
          <input type="date" id="date-to" placeholder="To">
        </div>
      </div>
    </div>
    <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
    <div class="decisions-table">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Decision</th>
            <th>Type</th>
            <th>Epic</th>
            <th>Creator</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="decisions-body">
          <tr><td colspan="7" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="delete-modal">
    <div class="modal">
      <h2>üóëÔ∏è Delete Decision</h2>
      <p>Are you sure you want to delete decision <strong id="delete-decision-id">#0</strong>? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="modal-btn modal-btn-delete" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Decision Detail Modal -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal detail-modal">
      <div class="detail-header">
        <h2 id="detail-title">Decision Details</h2>
        <button class="close-btn" onclick="closeDetailModal()">‚úï Close</button>
      </div>

      <div class="detail-section">
        <h3>Decision</h3>
        <div class="content" id="detail-decision-text"></div>
      </div>

      <div class="detail-grid">
        <div class="detail-item">
          <label>Type</label>
          <div class="value" id="detail-type"></div>
        </div>
        <div class="detail-item">
          <label>Creator</label>
          <div class="value" id="detail-creator"></div>
        </div>
        <div class="detail-item">
          <label>Date</label>
          <div class="value" id="detail-date"></div>
        </div>
        <div class="detail-item" id="detail-confidence-container" style="display: none;">
          <label>AI Confidence</label>
          <div class="value" id="detail-confidence"></div>
        </div>
      </div>

      <div class="detail-section" id="detail-meeting-section" style="display: none;">
        <h3>Meeting Context</h3>
        <div class="content" id="detail-meeting-info"></div>
      </div>

      <div class="detail-section" id="detail-epic-section" style="display: none;">
        <h3>Jira Epic</h3>
        <div class="content" id="detail-epic-info"></div>
      </div>

      <div class="detail-section" id="detail-tags-section" style="display: none;">
        <h3>Tags</h3>
        <div class="content" id="detail-tags"></div>
      </div>
    </div>
  </div>

  <script>
    let allDecisions = [];
    let deleteTargetId = null;

    async function fetchStats() {
      try {
        const r = await fetch('/api/stats');
        const d = await r.json();
        document.getElementById('total-count').textContent = d.total;
        document.getElementById('product-count').textContent = d.byType.product || 0;
        document.getElementById('ux-count').textContent = d.byType.ux || 0;
        document.getElementById('technical-count').textContent = d.byType.technical || 0;
        document.getElementById('week-count').textContent = d.lastWeek;
      } catch (e) {}
    }

    async function fetchDecisions() {
      try {
        const s = document.getElementById('search').value;
        const t = document.getElementById('type-filter').value;
        const e = document.getElementById('epic-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        const p = new URLSearchParams();
        if (s) p.append('search', s);
        if (t) p.append('type', t);
        if (e) p.append('epic', e);
        if (dateFrom) p.append('date_from', dateFrom);
        if (dateTo) p.append('date_to', dateTo);
        p.append('limit', '100');

        const r = await fetch(`/api/decisions?${p}`);
        const d = await r.json();
        allDecisions = d.decisions;
        renderDecisions(d.decisions);
      } catch (err) {
        document.getElementById('decisions-body').innerHTML = '<tr><td colspan="7">Error</td></tr>';
      }
    }

    function renderDecisions(decisions) {
      const tbody = document.getElementById('decisions-body');
      if (decisions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No decisions</td></tr>';
        return;
      }
      tbody.innerHTML = decisions.map((d, index) => {
        let epicCell = '-';
        if (d.epic_key) {
          if (d.jira_data && d.jira_data.url) {
            epicCell = `<a href="${d.jira_data.url}" target="_blank" class="jira-link">${d.epic_key}</a>`;
          } else {
            epicCell = d.epic_key;
          }
        }
        // Truncate decision text if too long
        const maxLength = 80;
        const truncatedText = d.text.length > maxLength ? d.text.substring(0, maxLength) + '...' : d.text;

        return `<tr>
          <td><strong>#${d.id}</strong></td>
          <td class="decision-text" title="${d.text}">${truncatedText}</td>
          <td><span class="badge badge-${d.type}">${d.type}</span></td>
          <td>${epicCell}</td>
          <td>${d.creator}</td>
          <td>${new Date(d.timestamp).toLocaleDateString()}</td>
          <td>
            <button class="view-btn" onclick="openDetailModal(${index})">üëÅÔ∏è View</button>
            <button class="delete-btn" onclick="openDeleteModal(${d.id})">üóëÔ∏è</button>
          </td>
        </tr>`;
      }).join('');
    }

    function openDeleteModal(id) {
      deleteTargetId = id;
      document.getElementById('delete-decision-id').textContent = '#' + id;
      document.getElementById('delete-modal').classList.add('active');
    }

    function closeDeleteModal() {
      deleteTargetId = null;
      document.getElementById('delete-modal').classList.remove('active');
    }

    function openDetailModal(index) {
      const decision = allDecisions[index];

      // Set title
      document.getElementById('detail-title').textContent = `Decision #${decision.id}`;

      // Set decision text
      document.getElementById('detail-decision-text').textContent = decision.text;

      // Set type with badge
      document.getElementById('detail-type').innerHTML = `<span class="badge badge-${decision.type}">${decision.type}</span>`;

      // Set creator and date
      document.getElementById('detail-creator').textContent = decision.creator;
      document.getElementById('detail-date').textContent = new Date(decision.timestamp).toLocaleString();

      // Handle meeting context / alternatives
      if (decision.alternatives) {
        document.getElementById('detail-meeting-section').style.display = 'block';
        document.getElementById('detail-meeting-info').innerHTML = decision.alternatives.replace(/\n/g, '<br>');
      } else {
        document.getElementById('detail-meeting-section').style.display = 'none';
      }

      // Handle Jira epic
      if (decision.epic_key) {
        document.getElementById('detail-epic-section').style.display = 'block';
        let epicHtml = '';
        if (decision.jira_data && decision.jira_data.url) {
          epicHtml = `
            <strong><a href="${decision.jira_data.url}" target="_blank" class="jira-link">${decision.epic_key}</a></strong><br>
            <div style="margin-top: 8px;">${decision.jira_data.summary || ''}</div>
            <div style="margin-top: 5px; font-size: 13px; color: #616061;">
              ${decision.jira_data.type || ''} ‚Ä¢ ${decision.jira_data.status || ''}
            </div>
          `;
        } else {
          epicHtml = decision.epic_key;
        }
        document.getElementById('detail-epic-info').innerHTML = epicHtml;
      } else {
        document.getElementById('detail-epic-section').style.display = 'none';
      }

      // Handle tags
      if (decision.tags && decision.tags.length > 0) {
        document.getElementById('detail-tags-section').style.display = 'block';
        document.getElementById('detail-tags').innerHTML = decision.tags.map(t => `<span class="tag">${t}</span>`).join(' ');
      } else {
        document.getElementById('detail-tags-section').style.display = 'none';
      }

      // Show modal
      document.getElementById('detail-modal').classList.add('active');
    }

    function closeDetailModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    async function confirmDelete() {
      if (!deleteTargetId) return;
      try {
        const response = await fetch(`/api/decisions/${deleteTargetId}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          closeDeleteModal();
          fetchStats();
          fetchDecisions();
        } else {
          alert('Failed to delete decision');
        }
      } catch (err) {
        alert('Error deleting decision');
      }
    }

    function exportToCSV() {
      const csv = [
        ['ID', 'Decision', 'Type', 'Epic', 'Summary', 'Tags', 'Creator', 'Date'],
        ...allDecisions.map(d => [
          d.id,
          d.text,
          d.type,
          d.epic_key || '',
          (d.jira_data && d.jira_data.summary) || '',
          d.tags.join(','),
          d.creator,
          new Date(d.timestamp).toLocaleDateString()
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'decisions.csv';
      a.click();
    }

    function setDatePreset(preset) {
      const today = new Date();
      const dateFrom = document.getElementById('date-from');
      const dateTo = document.getElementById('date-to');

      // Clear active state from all preset buttons
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      switch(preset) {
        case 'today':
          dateFrom.value = formatDate(today);
          dateTo.value = formatDate(today);
          break;
        case 'last7':
          const last7 = new Date(today);
          last7.setDate(today.getDate() - 7);
          dateFrom.value = formatDate(last7);
          dateTo.value = formatDate(today);
          break;
        case 'last30':
          const last30 = new Date(today);
          last30.setDate(today.getDate() - 30);
          dateFrom.value = formatDate(last30);
          dateTo.value = formatDate(today);
          break;
        case 'thisMonth':
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          dateFrom.value = formatDate(firstDay);
          dateTo.value = formatDate(today);
          break;
        case 'lastMonth':
          const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
          dateFrom.value = formatDate(lastMonthStart);
          dateTo.value = formatDate(lastMonthEnd);
          break;
      }
      fetchDecisions();
    }

    function clearDateFilter() {
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      fetchDecisions();
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    document.getElementById('search').addEventListener('input', debounce(fetchDecisions, 500));
    document.getElementById('type-filter').addEventListener('change', fetchDecisions);
    document.getElementById('epic-filter').addEventListener('input', debounce(fetchDecisions, 500));
    document.getElementById('date-from').addEventListener('change', fetchDecisions);
    document.getElementById('date-to').addEventListener('change', fetchDecisions);

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Close modals on overlay click
    document.getElementById('delete-modal').addEventListener('click', function(e) {
      if (e.target === this) closeDeleteModal();
    });
    document.getElementById('detail-modal').addEventListener('click', function(e) {
      if (e.target === this) closeDetailModal();
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDeleteModal();
        closeDetailModal();
      }
    });

    fetchStats();
    fetchDecisions();
    setInterval(() => { fetchStats(); fetchDecisions(); }, 30000);
  </script>
</body>
</html>
