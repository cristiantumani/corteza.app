<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      min-height: 100vh;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 24px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-links a {
      color: #6366f1;
      text-decoration: none;
      margin-left: 20px;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: #4f46e5;
      text-decoration: underline;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

    h1 {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .stat-card {
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      transition: box-shadow 0.3s;
    }

    .stat-card:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 500;
    }

    .stat-card .number {
      font-size: 30px;
      font-weight: 600;
      color: #0f172a;
    }

    .filters {
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    .filter-group { flex: 1; min-width: 220px; }

    .filter-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #334155;
    }

    .filter-group input, .filter-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.15s;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .decisions-table {
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    table { width: 100%; border-collapse: collapse; }

    thead { background: #f8fafc; }

    th {
      text-align: left;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 16px 24px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }

    tbody tr {
      transition: background-color 0.15s;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
      text-transform: capitalize;
      border: 1px solid;
    }

    .badge-product {
      background: #ecfdf5;
      color: #047857;
      border-color: #a7f3d0;
    }

    .badge-ux {
      background: #f5f3ff;
      color: #6d28d9;
      border-color: #ddd6fe;
    }

    .badge-technical {
      background: #fffbeb;
      color: #b45309;
      border-color: #fde68a;
    }

    .badge-decision {
      background: #dbeafe;
      color: #1e40af;
      border-color: #93c5fd;
    }

    .badge-explanation {
      background: #fef3c7;
      color: #92400e;
      border-color: #fcd34d;
    }

    .badge-context {
      background: #e0e7ff;
      color: #4338ca;
      border-color: #a5b4fc;
    }

    .tag {
      background: #f1f5f9;
      color: #334155;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      margin: 2px;
      display: inline-block;
      font-weight: 500;
      border: 1px solid #e2e8f0;
    }

    .jira-link {
      color: #6366f1;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.15s;
    }

    .jira-link:hover {
      color: #4f46e5;
      text-decoration: underline;
    }

    .jira-title { color: #64748b; font-size: 12px; }

    .loading {
      text-align: center;
      padding: 60px;
      color: #718096;
      font-size: 15px;
    }

    .export-btn {
      background: #eef2ff;
      color: #4f46e5;
      border: 1px solid #c7d2fe;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.15s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .export-btn:hover {
      background: #e0e7ff;
      border-color: #a5b4fc;
    }

    .delete-btn {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .delete-btn:hover {
      background: #fee2e2;
      border-color: #fca5a5;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: #fff;
      padding: 32px;
      border-radius: 20px;
      max-width: 440px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal h2 {
      margin-bottom: 16px;
      font-size: 22px;
      font-weight: 700;
      color: hsl(222, 47%, 11%);
    }

    .modal p {
      margin-bottom: 24px;
      color: hsl(215, 16%, 47%);
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modal-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
    }

    .modal-btn-cancel {
      background: #e2e8f0;
      color: #2d3748;
    }

    .modal-btn-cancel:hover {
      background: #cbd5e0;
    }

    .modal-btn-delete {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    .modal-btn-delete:hover {
      background: #fecaca;
      border-color: #f87171;
    }

    .view-btn {
      background: #eef2ff;
      color: #4f46e5;
      border: 1px solid #c7d2fe;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      margin-right: 6px;
      transition: all 0.15s;
    }

    .view-btn:hover {
      background: #e0e7ff;
      border-color: #a5b4fc;
    }

    .decision-text {
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .detail-modal {
      max-width: 750px;
      width: 90%;
      text-align: left;
      max-height: 90vh;
      overflow-y: auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section h3 {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .detail-section .content {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      font-size: 15px;
      line-height: 1.6;
      border: 1px solid #e2e8f0;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .detail-item {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .detail-item label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      letter-spacing: 0.05em;
    }

    .detail-item .value {
      font-size: 15px;
      color: #1a1a1a;
      font-weight: 500;
    }

    .confidence-badge {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #a7f3d0;
      padding: 6px 14px;
      border-radius: 9999px;
      font-size: 13px;
      font-weight: 500;
      display: inline-block;
    }

    .close-btn {
      background: #e2e8f0;
      color: #2d3748;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #cbd5e0;
    }

    .date-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .preset-btn {
      background: hsl(0, 0%, 100%);
      border: 2px solid hsl(214, 32%, 91%);
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-btn:hover {
      border-color: hsl(215, 16%, 47%);
      background: hsl(210, 20%, 98%);
    }

    .preset-btn.active {
      background: #eef2ff;
      color: #4f46e5;
      border-color: #c7d2fe;
    }

    .date-inputs {
      display: flex;
      gap: 12px;
    }

    .date-inputs input {
      flex: 1;
    }

    .clear-dates-btn {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .clear-dates-btn:hover {
      background: #fecaca;
      border-color: #f87171;
    }

    .edit-btn {
      background: #d1fae5;
      color: #047857;
      border: 1px solid #a7f3d0;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }

    .edit-btn:hover {
      background: #a7f3d0;
      border-color: #6ee7b7;
    }

    .edit-modal {
      max-width: 650px;
      width: 90%;
      text-align: left;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #334155;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Inter', -apple-system, sans-serif;
      transition: all 0.15s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group small {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #718096;
    }

    .modal-btn-primary {
      background: #eef2ff;
      color: #4f46e5;
      border: 1px solid #c7d2fe;
    }

    .modal-btn-primary:hover {
      background: #e0e7ff;
      border-color: #a5b4fc;
    }

    footer {
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 24px 0;
      margin-top: 48px;
      text-align: center;
    }

    .footer-links {
      display: flex;
      gap: 24px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .footer-links a {
      color: #6366f1;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.15s;
    }

    .footer-links a:hover {
      color: #4f46e5;
      text-decoration: underline;
    }

    .footer-links .separator {
      color: #cbd5e0;
      font-weight: 300;
    }

    .footer-copyright {
      margin-top: 12px;
      font-size: 13px;
      color: #718096;
    }

    .gdpr-section {
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    .gdpr-section h2 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #1a1a1a;
      font-weight: 600;
    }

    .gdpr-section p {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .gdpr-actions {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .gdpr-btn {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .gdpr-btn-export {
      background: #d1fae5;
      color: #047857;
      border: 1px solid #a7f3d0;
    }

    .gdpr-btn-export:hover {
      background: #a7f3d0;
      border-color: #6ee7b7;
    }

    .gdpr-btn-info {
      background: #eef2ff;
      color: #4f46e5;
      border: 1px solid #c7d2fe;
    }

    .gdpr-btn-info:hover {
      background: #e0e7ff;
      border-color: #a5b4fc;
    }

    .gdpr-btn-danger {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    .gdpr-btn-danger:hover {
      background: #fecaca;
      border-color: #f87171;
    }

    .gdpr-warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .gdpr-warning p {
      color: #92400e;
      margin: 0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <h1>Dashboard</h1>
        <div class="nav-links">
          <a href="/ai-analytics?workspace_id=<WORKSPACE_ID>">ü§ñ AI Analytics</a>
          <a href="/auth/logout">Logout</a>
        </div>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="stats">
      <div class="stat-card"><h3>Total</h3><div class="number" id="total-count">-</div></div>
      <div class="stat-card"><h3>Decisions</h3><div class="number" id="decision-count">-</div></div>
      <div class="stat-card"><h3>Explanations</h3><div class="number" id="explanation-count">-</div></div>
      <div class="stat-card"><h3>Context</h3><div class="number" id="context-count">-</div></div>
      <div class="stat-card"><h3>Product</h3><div class="number" id="product-count">-</div></div>
      <div class="stat-card"><h3>UX</h3><div class="number" id="ux-count">-</div></div>
      <div class="stat-card"><h3>Technical</h3><div class="number" id="technical-count">-</div></div>
      <div class="stat-card"><h3>This Week</h3><div class="number" id="week-count">-</div></div>
    </div>

    <!-- GDPR / Data Management Section -->
    <div class="gdpr-section">
      <h2>üîí Data Privacy & Export</h2>
      <p>Manage your workspace data in compliance with GDPR and other privacy regulations.</p>

      <div class="gdpr-actions">
        <button class="gdpr-btn gdpr-btn-info" onclick="viewDataInfo()">
          üìä View Data Summary
        </button>
        <button class="gdpr-btn gdpr-btn-export" onclick="exportData('json')">
          üì• Export as JSON
        </button>
        <button class="gdpr-btn gdpr-btn-export" onclick="exportData('csv')">
          üì• Export as CSV
        </button>
        <button class="gdpr-btn gdpr-btn-danger" onclick="openDeleteAllModal()">
          üóëÔ∏è Delete All Workspace Data
        </button>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" id="search" placeholder="Search...">
      </div>
      <div class="filter-group">
        <label>Type</label>
        <select id="type-filter">
          <option value="">All Types</option>
          <option value="decision">Decision</option>
          <option value="explanation">Explanation</option>
          <option value="context">Context</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Category</label>
        <select id="category-filter">
          <option value="">All Categories</option>
          <option value="product">Product</option>
          <option value="ux">UX</option>
          <option value="technical">Technical</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Epic</label>
        <input type="text" id="epic-filter" placeholder="LOK-123">
      </div>
      <div class="filter-group" style="flex: 2; min-width: 400px;">
        <label>Date Range</label>
        <div class="date-presets">
          <button class="preset-btn" onclick="setDatePreset('today')">Today</button>
          <button class="preset-btn" onclick="setDatePreset('last7')">Last 7 days</button>
          <button class="preset-btn" onclick="setDatePreset('last30')">Last 30 days</button>
          <button class="preset-btn" onclick="setDatePreset('thisMonth')">This month</button>
          <button class="preset-btn" onclick="setDatePreset('lastMonth')">Last month</button>
          <button class="clear-dates-btn" onclick="clearDateFilter()">Clear</button>
        </div>
        <div class="date-inputs">
          <input type="date" id="date-from" placeholder="From">
          <input type="date" id="date-to" placeholder="To">
        </div>
      </div>
    </div>
    <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
    <div class="decisions-table">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Memory</th>
            <th>Type</th>
            <th>Category</th>
            <th>Epic</th>
            <th>Creator</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="decisions-body">
          <tr><td colspan="8" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <footer>
    <div class="container">
      <div class="footer-links">
        <a href="https://github.com/cristiantumani/corteza.app/blob/main/PRIVACY_POLICY.md" target="_blank">Privacy Policy</a>
        <span class="separator">‚Ä¢</span>
        <a href="https://github.com/cristiantumani/corteza.app/blob/main/TERMS_OF_SERVICE.md" target="_blank">Terms of Service</a>
        <span class="separator">‚Ä¢</span>
        <a href="mailto:cristiantumani@gmail.com">Contact Support</a>
      </div>
      <div class="footer-copyright">
        ¬© 2024 corteza.app. All rights reserved.
      </div>
    </div>
  </footer>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="delete-modal">
    <div class="modal">
      <h2>üóëÔ∏è Delete Memory</h2>
      <p>Are you sure you want to delete memory <strong id="delete-decision-id">#0</strong>? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="modal-btn modal-btn-delete" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Decision Detail Modal -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal detail-modal">
      <div class="detail-header">
        <h2 id="detail-title">Memory Details</h2>
        <div style="display: flex; gap: 10px;">
          <button class="edit-btn" onclick="openEditModal()">‚úèÔ∏è Edit</button>
          <button class="close-btn" onclick="closeDetailModal()">‚úï Close</button>
        </div>
      </div>

      <div class="detail-section">
        <h3>Content</h3>
        <div class="content" id="detail-decision-text"></div>
      </div>

      <div class="detail-grid">
        <div class="detail-item">
          <label>Type</label>
          <div class="value" id="detail-type"></div>
        </div>
        <div class="detail-item">
          <label>Creator</label>
          <div class="value" id="detail-creator"></div>
        </div>
        <div class="detail-item">
          <label>Date</label>
          <div class="value" id="detail-date"></div>
        </div>
        <div class="detail-item" id="detail-confidence-container" style="display: none;">
          <label>AI Confidence</label>
          <div class="value" id="detail-confidence"></div>
        </div>
      </div>

      <div class="detail-section" id="detail-meeting-section" style="display: none;">
        <h3>Meeting Context</h3>
        <div class="content" id="detail-meeting-info"></div>
      </div>

      <div class="detail-section" id="detail-epic-section" style="display: none;">
        <h3>Jira Epic</h3>
        <div class="content" id="detail-epic-info"></div>
      </div>

      <div class="detail-section" id="detail-tags-section" style="display: none;">
        <h3>Tags</h3>
        <div class="content" id="detail-tags"></div>
      </div>
    </div>
  </div>

  <!-- Edit Decision Modal -->
  <div class="modal-overlay" id="edit-modal">
    <div class="modal edit-modal">
      <div class="detail-header">
        <h2>‚úèÔ∏è Edit Memory</h2>
        <button class="close-btn" onclick="closeEditModal()">‚úï Cancel</button>
      </div>

      <form id="edit-form" onsubmit="saveEdit(event)">
        <input type="hidden" id="edit-decision-id">

        <div class="form-group">
          <label for="edit-decision-text">Content *</label>
          <textarea id="edit-decision-text" rows="4" required></textarea>
        </div>

        <div class="form-group">
          <label for="edit-decision-type">Type *</label>
          <select id="edit-decision-type" required>
            <option value="decision">Decision</option>
            <option value="explanation">Explanation</option>
            <option value="context">Context</option>
          </select>
        </div>

        <div class="form-group">
          <label for="edit-decision-category">Category (optional)</label>
          <select id="edit-decision-category">
            <option value="">None</option>
            <option value="product">Product</option>
            <option value="ux">UX</option>
            <option value="technical">Technical</option>
          </select>
          <small>Product, UX, or Technical domain</small>
        </div>

        <div class="form-group">
          <label for="edit-epic-key">Epic Key</label>
          <input type="text" id="edit-epic-key" placeholder="e.g. LOK-123">
          <small>Leave empty to remove epic link</small>
        </div>

        <div class="form-group">
          <label for="edit-tags">Tags</label>
          <input type="text" id="edit-tags" placeholder="tag1, tag2, tag3">
          <small>Comma-separated tags</small>
        </div>

        <div class="form-group">
          <label for="edit-alternatives">Additional Comments</label>
          <textarea id="edit-alternatives" rows="3"></textarea>
        </div>

        <div class="modal-buttons">
          <button type="button" class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="modal-btn modal-btn-primary">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete All Workspace Data Modal -->
  <div class="modal-overlay" id="delete-all-modal">
    <div class="modal">
      <h2>‚ö†Ô∏è Delete All Workspace Data</h2>
      <div class="gdpr-warning">
        <p><strong>WARNING:</strong> This action is PERMANENT and IRREVERSIBLE. All your workspace data will be deleted, including:</p>
      </div>
      <p style="text-align: left; margin: 16px 0;">
        ‚Ä¢ All decisions (<strong id="delete-all-decisions-count">-</strong> decisions)<br>
        ‚Ä¢ All AI suggestions (<strong id="delete-all-suggestions-count">-</strong> suggestions)<br>
        ‚Ä¢ All meeting transcripts (<strong id="delete-all-transcripts-count">-</strong> transcripts)<br>
        ‚Ä¢ All feedback data (<strong id="delete-all-feedback-count">-</strong> feedback)<br>
        ‚Ä¢ Your app installation record
      </p>
      <p><strong>Type "DELETE ALL DATA" to confirm:</strong></p>
      <input type="text" id="delete-all-confirm-input" placeholder="DELETE ALL DATA" style="width: 100%; padding: 12px; border: 2px solid #ef4444; border-radius: 8px; margin-bottom: 16px; font-size: 14px;">
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeDeleteAllModal()">Cancel</button>
        <button class="modal-btn modal-btn-delete" onclick="confirmDeleteAll()" id="delete-all-confirm-btn" disabled>Delete Everything</button>
      </div>
    </div>
  </div>

  <script>
    // Authentication check - must be logged in to access dashboard
    let currentUser = null;
    let WORKSPACE_ID = null;

    // Check authentication status on page load
    async function checkAuth() {
      try {
        const response = await fetch('/auth/me');
        const data = await response.json();

        if (!data.authenticated) {
          // Not authenticated - redirect to login
          window.location.href = '/auth/login?return=' + encodeURIComponent(window.location.pathname);
          return false;
        }

        // Authenticated - store user info
        currentUser = data.user;
        WORKSPACE_ID = data.user.workspace_id;

        // Update header with user info
        updateHeader();

        return true;
      } catch (err) {
        console.error('Auth check failed:', err);
        // Redirect to login on error
        window.location.href = '/auth/login';
        return false;
      }
    }

    // Update header with user info and logout button
    function updateHeader() {
      const header = document.querySelector('header .container');
      const h1 = header.querySelector('h1');

      // Update AI analytics link with workspace_id
      const analyticsLink = document.querySelector('a[href*="ai-analytics"]');
      if (analyticsLink) {
        analyticsLink.href = `/ai-analytics?workspace_id=${WORKSPACE_ID}`;
      }

      // Update chat workspace info
      const chatWorkspaceInfo = document.getElementById('chat-workspace-info');
      if (chatWorkspaceInfo) {
        chatWorkspaceInfo.textContent = `Workspace: ${currentUser.workspace_name} (${WORKSPACE_ID})`;
      }

      // Add user info next to title
      h1.innerHTML += `
        <span style="font-size: 14px; font-weight: 400; margin-left: 20px; color: #718096;">
          ${currentUser.workspace_name} ‚Ä¢ ${currentUser.user_name}
        </span>
        <a href="/auth/logout" style="font-size: 14px; font-weight: 400; margin-left: 15px; color: #667eea; text-decoration: none;">
          Logout ‚Üí
        </a>
      `;
    }

    let allDecisions = [];
    let deleteTargetId = null;
    let currentDecisionIndex = null;

    async function fetchStats() {
      try {
        const r = await fetch(`/api/stats?workspace_id=${WORKSPACE_ID}`);
        const d = await r.json();
        document.getElementById('total-count').textContent = d.total;
        document.getElementById('decision-count').textContent = d.byType.decision || 0;
        document.getElementById('explanation-count').textContent = d.byType.explanation || 0;
        document.getElementById('context-count').textContent = d.byType.context || 0;
        document.getElementById('product-count').textContent = d.byCategory?.product || 0;
        document.getElementById('ux-count').textContent = d.byCategory?.ux || 0;
        document.getElementById('technical-count').textContent = d.byCategory?.technical || 0;
        document.getElementById('week-count').textContent = d.lastWeek;
      } catch (e) {}
    }

    async function fetchDecisions() {
      try {
        const s = document.getElementById('search').value;
        const t = document.getElementById('type-filter').value;
        const c = document.getElementById('category-filter').value;
        const e = document.getElementById('epic-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        const p = new URLSearchParams();
        p.append('workspace_id', WORKSPACE_ID);  // ADD workspace_id
        if (s) p.append('search', s);
        if (t) p.append('type', t);
        if (c) p.append('category', c);
        if (e) p.append('epic', e);
        if (dateFrom) p.append('date_from', dateFrom);
        if (dateTo) p.append('date_to', dateTo);
        p.append('limit', '100');

        const r = await fetch(`/api/decisions?${p}`);
        const d = await r.json();
        allDecisions = d.decisions;
        renderDecisions(d.decisions);
      } catch (err) {
        document.getElementById('decisions-body').innerHTML = '<tr><td colspan="8">Error</td></tr>';
      }
    }

    function renderDecisions(decisions) {
      const tbody = document.getElementById('decisions-body');
      if (decisions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No memories found</td></tr>';
        return;
      }
      tbody.innerHTML = decisions.map((d, index) => {
        let epicCell = '-';
        if (d.epic_key) {
          if (d.jira_data && d.jira_data.url) {
            epicCell = `<a href="${d.jira_data.url}" target="_blank" class="jira-link">${d.epic_key}</a>`;
          } else {
            epicCell = d.epic_key;
          }
        }
        // Truncate decision text if too long
        const maxLength = 80;
        const truncatedText = d.text.length > maxLength ? d.text.substring(0, maxLength) + '...' : d.text;

        // Backward compatibility: if type has old values, treat as category
        let actualType = d.type;
        let actualCategory = d.category;
        if (['product', 'ux', 'technical'].includes(d.type)) {
          actualCategory = d.type;
          actualType = null;
        }

        const typeBadge = actualType ? `<span class="badge badge-${actualType}">${actualType}</span>` : '-';
        const categoryBadge = actualCategory ? `<span class="badge badge-${actualCategory}">${actualCategory}</span>` : '-';

        return `<tr>
          <td><strong>#${d.id}</strong></td>
          <td class="decision-text" title="${d.text}">${truncatedText}</td>
          <td>${typeBadge}</td>
          <td>${categoryBadge}</td>
          <td>${epicCell}</td>
          <td>${d.creator}</td>
          <td>${new Date(d.timestamp).toLocaleDateString()}</td>
          <td>
            <button class="view-btn" onclick="openDetailModal(${index})">üëÅÔ∏è View</button>
            <button class="delete-btn" onclick="openDeleteModal(${d.id})">üóëÔ∏è</button>
          </td>
        </tr>`;
      }).join('');
    }

    function openDeleteModal(id) {
      deleteTargetId = id;
      document.getElementById('delete-decision-id').textContent = '#' + id;
      document.getElementById('delete-modal').classList.add('active');
    }

    function closeDeleteModal() {
      deleteTargetId = null;
      document.getElementById('delete-modal').classList.remove('active');
    }

    function openDetailModal(index) {
      currentDecisionIndex = index;
      const decision = allDecisions[index];

      // Set title
      document.getElementById('detail-title').textContent = `Decision #${decision.id}`;

      // Set decision text
      document.getElementById('detail-decision-text').textContent = decision.text;

      // Set type with badge
      document.getElementById('detail-type').innerHTML = `<span class="badge badge-${decision.type}">${decision.type}</span>`;

      // Set creator and date
      document.getElementById('detail-creator').textContent = decision.creator;
      document.getElementById('detail-date').textContent = new Date(decision.timestamp).toLocaleString();

      // Handle meeting context / alternatives
      if (decision.alternatives) {
        document.getElementById('detail-meeting-section').style.display = 'block';
        document.getElementById('detail-meeting-info').innerHTML = decision.alternatives.replace(/\n/g, '<br>');
      } else {
        document.getElementById('detail-meeting-section').style.display = 'none';
      }

      // Handle Jira epic
      if (decision.epic_key) {
        document.getElementById('detail-epic-section').style.display = 'block';
        let epicHtml = '';
        if (decision.jira_data && decision.jira_data.url) {
          epicHtml = `
            <strong><a href="${decision.jira_data.url}" target="_blank" class="jira-link">${decision.epic_key}</a></strong><br>
            <div style="margin-top: 8px;">${decision.jira_data.summary || ''}</div>
            <div style="margin-top: 5px; font-size: 13px; color: #616061;">
              ${decision.jira_data.type || ''} ‚Ä¢ ${decision.jira_data.status || ''}
            </div>
          `;
        } else {
          epicHtml = decision.epic_key;
        }
        document.getElementById('detail-epic-info').innerHTML = epicHtml;
      } else {
        document.getElementById('detail-epic-section').style.display = 'none';
      }

      // Handle tags
      if (decision.tags && decision.tags.length > 0) {
        document.getElementById('detail-tags-section').style.display = 'block';
        document.getElementById('detail-tags').innerHTML = decision.tags.map(t => `<span class="tag">${t}</span>`).join(' ');
      } else {
        document.getElementById('detail-tags-section').style.display = 'none';
      }

      // Show modal
      document.getElementById('detail-modal').classList.add('active');
    }

    function closeDetailModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    function openEditModal() {
      if (currentDecisionIndex === null) return;

      const decision = allDecisions[currentDecisionIndex];

      // Pre-fill the form with current values
      document.getElementById('edit-decision-id').value = decision.id;
      document.getElementById('edit-decision-text').value = decision.text;
      document.getElementById('edit-decision-type').value = decision.type;
      document.getElementById('edit-decision-category').value = decision.category || '';
      document.getElementById('edit-epic-key').value = decision.epic_key || '';
      document.getElementById('edit-tags').value = decision.tags ? decision.tags.join(', ') : '';
      document.getElementById('edit-alternatives').value = decision.alternatives || '';

      // Close detail modal and open edit modal
      closeDetailModal();
      document.getElementById('edit-modal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      // Optionally reopen the detail modal
      if (currentDecisionIndex !== null) {
        openDetailModal(currentDecisionIndex);
      }
    }

    async function saveEdit(event) {
      event.preventDefault();

      const decisionId = document.getElementById('edit-decision-id').value;
      const text = document.getElementById('edit-decision-text').value.trim();
      const type = document.getElementById('edit-decision-type').value;
      const category = document.getElementById('edit-decision-category').value || null;
      const epicKey = document.getElementById('edit-epic-key').value.trim();
      const tagsString = document.getElementById('edit-tags').value.trim();
      const alternatives = document.getElementById('edit-alternatives').value.trim();

      // Parse tags
      const tags = tagsString ? tagsString.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];

      // Build update payload
      const updates = {
        text,
        type,
        category,
        epic_key: epicKey || null,
        tags,
        alternatives: alternatives || null
      };

      try {
        const response = await fetch(`/api/decisions/${decisionId}?workspace_id=${WORKSPACE_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });

        if (response.ok) {
          closeEditModal();
          currentDecisionIndex = null;
          await fetchStats();
          await fetchDecisions();
          alert('Decision updated successfully!');
        } else {
          const error = await response.json();
          alert('Failed to update decision: ' + (error.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error updating decision:', err);
        alert('Error updating decision. Please try again.');
      }
    }

    async function confirmDelete() {
      if (!deleteTargetId) return;
      try {
        const response = await fetch(`/api/decisions/${deleteTargetId}?workspace_id=${WORKSPACE_ID}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          closeDeleteModal();
          fetchStats();
          fetchDecisions();
        } else {
          alert('Failed to delete decision');
        }
      } catch (err) {
        alert('Error deleting decision');
      }
    }

    function exportToCSV() {
      const csv = [
        ['ID', 'Decision', 'Type', 'Category', 'Epic', 'Summary', 'Tags', 'Creator', 'Date'],
        ...allDecisions.map(d => [
          d.id,
          d.text,
          d.type || '',
          d.category || '',
          d.epic_key || '',
          (d.jira_data && d.jira_data.summary) || '',
          d.tags.join(','),
          d.creator,
          new Date(d.timestamp).toLocaleDateString()
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'decisions.csv';
      a.click();
    }

    function setDatePreset(preset) {
      const today = new Date();
      const dateFrom = document.getElementById('date-from');
      const dateTo = document.getElementById('date-to');

      // Clear active state from all preset buttons
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      switch(preset) {
        case 'today':
          dateFrom.value = formatDate(today);
          dateTo.value = formatDate(today);
          break;
        case 'last7':
          const last7 = new Date(today);
          last7.setDate(today.getDate() - 7);
          dateFrom.value = formatDate(last7);
          dateTo.value = formatDate(today);
          break;
        case 'last30':
          const last30 = new Date(today);
          last30.setDate(today.getDate() - 30);
          dateFrom.value = formatDate(last30);
          dateTo.value = formatDate(today);
          break;
        case 'thisMonth':
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          dateFrom.value = formatDate(firstDay);
          dateTo.value = formatDate(today);
          break;
        case 'lastMonth':
          const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
          dateFrom.value = formatDate(lastMonthStart);
          dateTo.value = formatDate(lastMonthEnd);
          break;
      }
      fetchDecisions();
    }

    function clearDateFilter() {
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      fetchDecisions();
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    document.getElementById('search').addEventListener('input', debounce(fetchDecisions, 500));
    document.getElementById('type-filter').addEventListener('change', fetchDecisions);
    document.getElementById('category-filter').addEventListener('change', fetchDecisions);
    document.getElementById('epic-filter').addEventListener('input', debounce(fetchDecisions, 500));
    document.getElementById('date-from').addEventListener('change', fetchDecisions);
    document.getElementById('date-to').addEventListener('change', fetchDecisions);

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Close modals on overlay click
    document.getElementById('delete-modal').addEventListener('click', function(e) {
      if (e.target === this) closeDeleteModal();
    });
    document.getElementById('detail-modal').addEventListener('click', function(e) {
      if (e.target === this) closeDetailModal();
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDeleteModal();
        closeDetailModal();
        closeDeleteAllModal();
      }
    });

    // GDPR Functions
    async function viewDataInfo() {
      try {
        const response = await fetch(`/api/gdpr/info?workspace_id=${WORKSPACE_ID}`);
        const data = await response.json();

        alert(`üìä Workspace Data Summary\n\n` +
          `Workspace ID: ${data.workspace_id}\n` +
          `Installed: ${data.installed ? 'Yes' : 'No'}\n` +
          `Installed At: ${data.installed_at || 'N/A'}\n\n` +
          `Data Records:\n` +
          `‚Ä¢ Decisions: ${data.data_summary.decisions}\n` +
          `‚Ä¢ AI Suggestions: ${data.data_summary.ai_suggestions}\n` +
          `‚Ä¢ Meeting Transcripts: ${data.data_summary.meeting_transcripts}\n` +
          `‚Ä¢ AI Feedback: ${data.data_summary.ai_feedback}\n\n` +
          `Total Records: ${data.total_records}\n\n` +
          `GDPR Rights:\n` +
          `‚úì Export your data (JSON/CSV)\n` +
          `‚úì Delete all your data\n` +
          `‚úì Access all your data via dashboard`
        );
      } catch (err) {
        alert('Failed to fetch data info. Please try again.');
        console.error('Error fetching data info:', err);
      }
    }

    function exportData(format) {
      const exportUrl = `/api/gdpr/export?workspace_id=${WORKSPACE_ID}&format=${format}`;
      const link = document.createElement('a');
      link.href = exportUrl;
      link.download = `workspace_${WORKSPACE_ID}_export.${format}`;
      link.click();

      console.log(`üì• Exporting data as ${format.toUpperCase()} for workspace ${WORKSPACE_ID}`);
    }

    async function openDeleteAllModal() {
      try {
        // Fetch data info to show counts
        const response = await fetch(`/api/gdpr/info?workspace_id=${WORKSPACE_ID}`);
        const data = await response.json();

        document.getElementById('delete-all-decisions-count').textContent = data.data_summary.decisions;
        document.getElementById('delete-all-suggestions-count').textContent = data.data_summary.ai_suggestions;
        document.getElementById('delete-all-transcripts-count').textContent = data.data_summary.meeting_transcripts;
        document.getElementById('delete-all-feedback-count').textContent = data.data_summary.ai_feedback;

        document.getElementById('delete-all-modal').classList.add('active');
      } catch (err) {
        alert('Failed to load data info. Please try again.');
        console.error('Error opening delete all modal:', err);
      }
    }

    function closeDeleteAllModal() {
      document.getElementById('delete-all-modal').classList.remove('active');
      document.getElementById('delete-all-confirm-input').value = '';
      document.getElementById('delete-all-confirm-btn').disabled = true;
    }

    // Enable delete button only when confirmation text is correct
    document.getElementById('delete-all-confirm-input').addEventListener('input', function(e) {
      const confirmBtn = document.getElementById('delete-all-confirm-btn');
      if (e.target.value === 'DELETE ALL DATA') {
        confirmBtn.disabled = false;
      } else {
        confirmBtn.disabled = true;
      }
    });

    async function confirmDeleteAll() {
      const confirmInput = document.getElementById('delete-all-confirm-input').value;

      if (confirmInput !== 'DELETE ALL DATA') {
        alert('Please type "DELETE ALL DATA" to confirm deletion.');
        return;
      }

      try {
        const response = await fetch(`/api/gdpr/delete-all?workspace_id=${WORKSPACE_ID}&confirm=DELETE_ALL_DATA`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
          alert(`‚úÖ All workspace data has been permanently deleted!\n\n` +
            `Deleted:\n` +
            `‚Ä¢ Decisions: ${result.summary.deleted.decisions}\n` +
            `‚Ä¢ AI Suggestions: ${result.summary.deleted.ai_suggestions}\n` +
            `‚Ä¢ Meeting Transcripts: ${result.summary.deleted.meeting_transcripts}\n` +
            `‚Ä¢ AI Feedback: ${result.summary.deleted.ai_feedback}\n` +
            `‚Ä¢ Installation: ${result.summary.deleted.installation}\n\n` +
            `Total Records Deleted: ${result.summary.total_records_deleted}\n\n` +
            `The page will now reload.`
          );

          closeDeleteAllModal();

          // Reload page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          alert('Failed to delete data: ' + (result.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error deleting data. Please try again.');
        console.error('Error deleting all data:', err);
      }
    }

    // Initialize dashboard - check auth first, then load data
    (async function init() {
      const authenticated = await checkAuth();
      if (authenticated) {
        fetchStats();
        fetchDecisions();
        setInterval(() => { fetchStats(); fetchDecisions(); }, 30000);
      }
    })();
  </script>

  <!-- Semantic Search Chat Widget -->
  <div id="chat-widget" class="chat-widget">
    <div id="chat-toggle" class="chat-toggle">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    </div>

    <div id="chat-container" class="chat-container" style="display:none;">
      <div class="chat-header">
        <div>
          <h3>ü§ñ Ask about your decisions</h3>
          <p>Semantic search powered by AI</p>
          <p id="chat-workspace-info" style="font-size: 11px; opacity: 0.7; margin-top: 4px;"></p>
        </div>
        <button id="chat-close" class="chat-close-btn">√ó</button>
      </div>

      <div id="chat-messages" class="chat-messages"></div>

      <div class="chat-input-container">
        <input
          type="text"
          id="chat-input"
          class="chat-input"
          placeholder='Try "show me AEM decisions" or "what did we decide about performance?"'
        />
        <button id="chat-send" class="chat-send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <style>
    .chat-widget {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .chat-toggle {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
      color: white;
    }

    .chat-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    .chat-container {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 420px;
      max-width: calc(100vw - 48px);
      height: 600px;
      max-height: calc(100vh - 140px);
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .chat-header h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .chat-header p {
      margin: 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .chat-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      line-height: 1;
      transition: background 0.2s;
    }

    .chat-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8fafc;
    }

    .chat-message {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
      display: flex;
      justify-content: flex-end;
    }

    .chat-message.bot {
      display: flex;
      justify-content: flex-start;
    }

    .chat-message-content {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .chat-message.user .chat-message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.bot .chat-message-content {
      background: white;
      color: #1a1a1a;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
    }

    .chat-message.bot .chat-message-content p {
      margin: 0 0 8px 0;
    }

    .chat-message.bot .chat-message-content p:last-child {
      margin-bottom: 0;
    }

    .chat-message.bot .chat-message-content strong {
      color: #667eea;
    }

    .chat-message.bot .chat-message-content ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    .chat-message.bot .chat-message-content li {
      margin: 4px 0;
    }

    .chat-decision-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-decision-card:hover {
      background: #eff6ff;
      border-color: #93c5fd;
    }

    .chat-decision-title {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }

    .chat-decision-meta {
      font-size: 12px;
      color: #64748b;
    }

    .chat-typing {
      display: flex;
      gap: 4px;
      padding: 16px;
    }

    .chat-typing span {
      width: 8px;
      height: 8px;
      background: #cbd5e1;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
    .chat-typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .chat-input-container {
      display: flex;
      gap: 8px;
      padding: 16px;
      background: white;
      border-top: 1px solid #e2e8f0;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #667eea;
    }

    .chat-send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .chat-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      margin: 8px 0;
    }

    @media (max-width: 640px) {
      .chat-container {
        width: calc(100vw - 48px);
        height: calc(100vh - 140px);
      }
    }
  </style>

  <script>
    // Chat Widget Functionality
    (function() {
      const chatToggle = document.getElementById('chat-toggle');
      const chatContainer = document.getElementById('chat-container');
      const chatClose = document.getElementById('chat-close');
      const chatInput = document.getElementById('chat-input');
      const chatSend = document.getElementById('chat-send');
      const chatMessages = document.getElementById('chat-messages');

      let isOpen = false;

      // Toggle chat
      chatToggle.addEventListener('click', () => {
        isOpen = !isOpen;
        chatContainer.style.display = isOpen ? 'flex' : 'none';
        if (isOpen) {
          chatInput.focus();
          // Show welcome message if empty
          if (chatMessages.children.length === 0) {
            addBotMessage('Hi! I can help you find decisions using natural language. Try asking me something like "show me all AEM decisions" or "what did we decide about performance?"');
          }
        }
      });

      chatClose.addEventListener('click', () => {
        isOpen = false;
        chatContainer.style.display = 'none';
      });

      // Send message
      async function sendMessage() {
        const query = chatInput.value.trim();
        if (!query) return;

        // Add user message
        addUserMessage(query);
        chatInput.value = '';

        // Show typing indicator
        const typingId = showTyping();

        try {
          // Call semantic search API
          const response = await fetch('/api/semantic-search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query,
              workspace_id: WORKSPACE_ID,
              conversational: true,
              limit: 10
            })
          });

          removeTyping(typingId);

          if (!response.ok) {
            throw new Error(`Search failed: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.success) {
            // Add conversational response
            addBotMessage(data.response, data.decisions);
          } else {
            addErrorMessage(data.error || 'Search failed');
          }

        } catch (error) {
          removeTyping(typingId);
          console.error('Chat error:', error);
          addErrorMessage(error.message || 'Failed to search. Please try again.');
        }
      }

      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message user';
        messageDiv.innerHTML = `<div class="chat-message-content">${escapeHtml(text)}</div>`;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      function addBotMessage(text, decisions = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message bot';

        // Convert markdown-like formatting to HTML
        let html = text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`(.*?)`/g, '<code>$1</code>')
          .split('\n\n').map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');

        messageDiv.innerHTML = `<div class="chat-message-content">${html}</div>`;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      function addErrorMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message bot';
        messageDiv.innerHTML = `<div class="chat-message-content"><div class="chat-error">‚ùå ${escapeHtml(text)}</div></div>`;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      function showTyping() {
        const typingDiv = document.createElement('div');
        const id = 'typing-' + Date.now();
        typingDiv.id = id;
        typingDiv.className = 'chat-message bot';
        typingDiv.innerHTML = `
          <div class="chat-message-content">
            <div class="chat-typing">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        `;
        chatMessages.appendChild(typingDiv);
        scrollToBottom();
        return id;
      }

      function removeTyping(id) {
        const typingDiv = document.getElementById(id);
        if (typingDiv) {
          typingDiv.remove();
        }
      }

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    })();
  </script>
</body>
</html>
